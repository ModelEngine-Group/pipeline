services:
  jade-db:
    container_name: jade-db
    hostname: jade-db
    image: ${REPO}/postgres:15.2-${VERSION}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
    networks:
      my-net:
        ipv4_address: 172.0.0.98
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "ModelEngine@123"
      LOG_HOME: /log/app
    volumes:
      - "./appengine/jade-db:/var/lib/postgresql/data"
      - "./appengine/log:/log/app/postgresql"
    ports:
      - "5432:5432"

  sql-initializer:
    container_name: sql-initializer
    hostname: sql-initializer
    image: ${REPO}/app-builder:${VERSION}
    networks:
      my-net:
        ipv4_address: 172.0.0.97
    volumes:
    - ./appengine/sql:/opt/appbuilder/sql
    entrypoint: ["/bin/bash", "-c"]
    command: |
      "
      rm -rf /opt/appbuilder/sql/*
      mv -f /opt/sql/* /opt/appbuilder/sql/
      
      touch /opt/appbuilder/sql/.initialization_complete
      echo 'SQL files initialized.'
      "

  db-initializer:
    container_name: db-initializer
    hostname: db-initializer
    image: ${REPO}/postgres:15.2-${VERSION}
    depends_on:
      jade-db:
        condition: service_healthy
      sql-initializer:
        condition: service_completed_successfully
    networks:
      my-net:
        ipv4_address: 172.0.0.99
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "ModelEngine@123"
      LOG_HOME: /log/app
      DB_HOST: jade-db
      DB_PORT: 5432
      DB_USER: postgres
      IS_UPGRADE: ${IS_UPGRADE}
      APIKEY: ${APIKEY}
    volumes:
      - ./appengine/sql:/opt/sql
    entrypoint: ["/bin/bash", "-c"]
    command: |
      " 
      chmod +x /opt/initDB.sh
      sed -i "s#TODO#${APIKEY}#g" /opt/sql/init/data/tr_init_models.sql
      bash /opt/initDB.sh app_builder /opt/sql
      "
    restart: "no"

  app-builder:
    container_name: app-builder
    hostname: app-builder
    image: ${REPO}/app-builder:${VERSION}
    depends_on:
      db-initializer:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://app-builder:8004/fit/check"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 180s
    networks:
      my-net:
        ipv4_address: 172.0.0.100
    environment:
      worker.host: localhost
      server.http.port: 8004
      matata.registry.host: localhost
      matata.registry.port: 8004
      fit.profiles.active: prod
      fit.datasource.primary: app-engine
      fit.datasource.instances.app-engine.mode: shared
      fit.datasource.instances.app-engine.url: jdbc:postgresql://jade-db/app_builder?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf8&autoReconnect=true&useSSL=true&allowPublicKeyRetrieval=true&useAffectedRows=true&connectTimeout=60000&socketTimeout=60000
      fit.datasource.instances.app-engine.username: postgres
      fit.datasource.instances.app-engine.password: "ModelEngine@123"
      openai-urls.internal: https://model-lite-router:8009/v1
      app-engine.pathPrefix: /api/jober
      LOG_HOME: /log/app
      LOG_NUM: 4320
      LOG_SIZE: "50M"
      app-engine.ttl.businessData: 360
      app-engine.ttl.nonBusinessData: 180
      task.expiredDays: 360
      filter.oauth2-filter: enable
      oauth.client.id: app-platform
      oauth.client.secret: RPh2J7SkZQ3r8XoUalNEXsdBIMrj7g3dZ8uUL5q3vVA
      oauth.client.redirect-uri: https://modelengine.nexent.tech/api/jober/v1/api/auth/callback
      oauth.login-endpoint: https://modelengine-ai.net/#/login
      oauth.oauth-endpoint: https://modelengine-ai.net
      oauth.client-api-endpoint: https://modelengine.nexent.tech/api/jober
      oauth.state-secret: Zf8yPqkN1tVh9uL4aR3sC7xE2jWm0BzQdG5nT6pH8yJrK9wX
      model.imageExtractor.model: THUDM/GLM-4.1V-9B-Thinking
      model.imageExtractor.url: https://api.siliconflow.cn/v1
      model.audioTranscriptions.model: TeleAI/TeleSpeechASR
      model.audioTranscriptions.url: https://api.siliconflow.cn/v1
      model.imageExtractor.apiKey: ${APIKEY}
      model.audioTranscriptions.apiKey: ${APIKEY}
    volumes:
      - "./appengine/fit-runtime:/var/store/tools"
      - "./appengine/log:/log/app/app-builder"
      - "./appengine/jade-db:/var/jade-db"
      - "./appengine/app-builder:/var/share"
    ports:
      - "8004:8004"

  fit-runtime-java:
    container_name: fit-runtime-java
    hostname: fit-runtime-java
    image: ${REPO}/fit-runtime-java:${VERSION}
    depends_on:
      app-builder:
        condition: service_healthy 
    networks:
      my-net:
        ipv4_address: 172.0.0.101
    environment:
      worker.id: fit-runtime-java
      worker.environment: prod
      worker.host: 172.0.0.101
      matata.registry.host: app-builder
      matata.registry.port: 8004
      matata.registry.environment: prod
      ENTRY_PLUGINS_PATH: /entry
      LOG_HOME: /log/app
    volumes:
      - "./appengine/app-builder:/var/share"
      - "./appengine/fit-runtime:/entry"
      - "./appengine/log:/log/app/runtime-java"
    ports:
      - "8090:8090"
 
  fit-runtime-python:
    container_name: fit-runtime-python
    hostname: fit-runtime-python
    image: ${REPO}/fit-runtime-python:${VERSION}
    depends_on:
      app-builder:
        condition: service_healthy 
    networks:
      my-net:
        ipv4_address: 172.0.0.102
    environment:
      WORKER_ID: fit-runtime-python
      WORK_ENV: prod
      LOCAL_IP: 172.0.0.102
      REGISTRY_HOST: app-builder
      REGISTRY_PORT: 8004
      matata.registry.environment: prod
      USER_PLUGINS_PATH: 'custom_dynamic_plugins/python'
      LOG_HOME: /log/app
      internet-search.api-key.exa: ${EXA_APIKEY}
      internet-search.api-key.tavily: ${TAVILY_APIKEY}
      internet-search.api-key.linkup: ${LINKUP_APIKEY}
    volumes:
      - "./appengine/app-builder:/var/share"
      - "./appengine/fit-runtime:/app/python/custom_dynamic_plugins"
      - "./appengine/log:/log/app/runtime-python"
    ports:
      - "9666:9666"
      
  web:
    container_name: web
    hostname: web
    image: ${REPO}/jade-web:${VERSION}
    depends_on:
      app-builder:
        condition: service_healthy
    networks:
      my-net:
        ipv4_address: 172.0.0.103
    environment:
      LOG_HOME: /log/app
    volumes:
      - "./appengine/log:/log/app/web"
    ports:
      - "8001:8001"

networks:
  my-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.0.0.0/24
          gateway: 172.0.0.1